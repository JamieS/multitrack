(function(){
  var storage = ('localStorage' in window);

  var uniqueId = function() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
      return v.toString(16);
    }).toUpperCase();
  };

  var read = function(key) {
    if (storage && window.localStorage.getItem(key)) return window.localStorage.getItem(cookieName);
    var theCookie=""+document.cookie;
    var ind=theCookie.indexOf(key);
    if (ind==-1 || key=="") return false;
    var ind1=theCookie.indexOf(';',ind);
    if (ind1==-1) ind1=theCookie.length;
    var value = unescape(theCookie.substring(ind+key.length+1,ind1));
    return value;
  };

  var store = function(key, value, msec_in_utc) {
    if (storage) window.localStorage.setItem(key, value)
    var expire = new Date(msec_in_utc);
    document.cookie = key + "=" + escape(value) + ";path=/" +";expires=" + expire.toUTCString();
  };

  var today = new Date().getTime();
  var referrer = (window.decodeURI)?window.decodeURI(document.referrer):document.referrer;
  var landing_page = (window.decodeURI)?window.decodeURI(window.location):window.location;
  var uniq = read('_y');
  var visit = read('_yy')

  if (!uniq) {
    uniq = uniqueId();
    store('_y', uniq, today + (1000*60*60*24*360*20)) // 20 years
  }

  if(!visit) {
    new Image().src = '<%= env['rack.url_scheme'] %>://<%= env['HTTP_HOST'] %>/record.gif?a='+ uniq + '&r=' +encodeURIComponent(referrer)+'&l='+encodeURIComponent(landing_page)+'&'+ today;
  }

  // set return visit cookie, always advance this.
  store('_yy', '.', today + (1000*60*30)); // 30 mins
}());

